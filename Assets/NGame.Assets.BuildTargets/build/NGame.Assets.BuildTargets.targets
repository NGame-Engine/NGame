<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">


  <Target Name="NGame_AssignPropertiesForAssets">
    <PropertyGroup>
      <NgAppsettingsPath>$(ProjectDir)appsettings.json</NgAppsettingsPath>
      <NGAssetListFile>$(ProjectDir)$(IntermediateOutputPath)ngame/NGAssets.g.txt</NGAssetListFile>
      <NgUsedAssetListFile>$(ProjectDir)$(IntermediateOutputPath)ngame/NGAssets.used.g.txt</NgUsedAssetListFile>
    </PropertyGroup>
  </Target>


  <Target Name="DeleteNGAssetListFile"
          BeforeTargets="BeforeRebuild"
          DependsOnTargets="NGame_AssignPropertiesForAssets">
    <Delete Files="$(NGAssetListFile)"/>
  </Target>


  <Target Name="DeleteNGAssetListFile"
          BeforeTargets="BeforeClean"
          DependsOnTargets="NGame_AssignPropertiesForAssets">
    <Delete Files="$(NGAssetListFile)"/>
  </Target>



  <Target Name="NGame_UpdateAssetsAAAAAAAAAAAAAAa" BeforeTargets="BeforeBuild"    >

    <ItemGroup>
      <NgAsset Include="**/*.ngasset" Exclude="bin/**/*;obj/**/*"/>
      <NgAsset
        Include="@(NgAsset -> '%(RelativeDir)%(FileName)')"
        Condition="Exists('%(RelativeDir)%(FileName)')"
      />

      <Content Include="@(NgAsset)"
               CopyToOutputDirectory="PreserveNewest"
               Link=".assets/%(RelativeDir)%(Filename)%(Extension)"
      />
    </ItemGroup>

    <Message Importance="high" Text="=== NgAsset: @(NgAsset)"/>
    <Message Importance="high" Text="=== Content: @(Content)"/>
  </Target>






  <Target
    Name="NGame_UpdateAssets"
    BeforeTargets="BeforeBuild"
    DependsOnTargets="NGame_AssignPropertiesForAssets"
  >
    <CallTarget Targets="NGame_UpdateAssets_UpdateItemGroupNgAsset"/>
    <CallTarget Targets="NGame_UpdateAssets_UpdateAssetList"/>
    
    <CallTarget Targets="NGame_UpdateAssets_UpdateItemGroupNgAssetLists"/>
    <CallTarget
      Targets="NGame_UpdateAssets_UpdateUsedAssetList"
      Condition="Exists('$(NgAppsettingsPath)')"
    />
  </Target>


  <Target Name="NGame_UpdateAssets_UpdateItemGroupNgAsset">
    <ItemGroup>
      <NgAsset Include="**/*.ngasset" Exclude="bin/**/*;obj/**/*"/>
      <NgAsset
        Include="@(NgAsset -> '%(RelativeDir)%(FileName)')"
        Condition="Exists('%(RelativeDir)%(FileName)')"
      />
    </ItemGroup>
  </Target>

  
  <Target Name="NGame_UpdateAssets_UpdateAssetList"
          Inputs="@(NgAsset)"
          Outputs="$(NGAssetListFile)">
    <Message Text="NGame: Updating asset list for this project..."/>
    <WriteLinesToFile
      Lines="@(NgAsset -> '$(NGAssetPackName)//$(ProjectDir)%(Identity)')"
      File="$(NGAssetListFile)"
      Overwrite="true"
      Encoding="Unicode"/>
    <Message Text="NGame: Asset list updated for this project."/>
  </Target>


  <Target Name="NGame_UpdateAssets_UpdateItemGroupNgAssetLists">
    <ItemGroup>
      <NgAssetLists Include="$(SolutionDir)**/$(NGAssetListFile)"/>
    </ItemGroup>
  </Target>


  <Target Name="NGame_UpdateAssets_UpdateUsedAssetList"
          Inputs="@(NgAssetLists)"
          Outputs="$(NgUsedAssetListFile)">
    <Message Text="NGame: Update list of used assets..."/>

    <Exec Command="dotnet tool list NGame.Assets.UsageDetector" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="PackageMissing"/>
    </Exec>

    <Exec Condition="$(PackageMissing)==1"
          Command="dotnet tool install NGame.Assets.UsageDetector ^
    --version 0.0.2-dev ^
    --create-manifest-if-needed"/>

    <Exec Command="dotnet tool update NGame.Assets.UsageDetector --version 0.0.8"/>

    <Exec Command="dotnet tool run ngame-asset-usages ^
    solutiondir=&quot;$(SolutionDir) &quot; ^
    appsettings=&quot;$(NgAppsettingsPath)&quot; ^
    output=&quot;$(NgUsedAssetListFile)&quot;"/>

    <Message Text="NGame:  List of used assets updated."/>
  </Target>


</Project>
