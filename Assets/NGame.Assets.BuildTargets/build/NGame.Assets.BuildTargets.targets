<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <NGAssetListFile>ngame/NGAssets.g.txt</NGAssetListFile>
    <NgUsedAssetListFile>ngame/NGAssets.used.g.txt</NgUsedAssetListFile>
    <NgAppsettingsPath>$(ProjectDir)appsettings.json</NgAppsettingsPath>
  </PropertyGroup>

  <ItemGroup>
    <NgAsset Include="**/*.ngasset" Exclude="bin/**/*;obj/**/*"/>
    <NgAssetLists Include="$(SolutionDir)**/$(NGAssetListFile)"/>
  </ItemGroup>


  <Target Name="AddCompanionFilesToNGAsset" BeforeTargets="BeforeBuild">
    <Message Text="Discovering NGame assets in $(ProjectDir)"/>
    <ItemGroup>
      <NgAsset
        Include="@(NgAsset -> '%(RelativeDir)%(FileName)')"
        Condition="Exists('%(RelativeDir)%(FileName)')"
      />
      <NgAssetChangeTrigger Include="@(NgAsset);appsettings*.json"/>
    </ItemGroup>
    <Message Text="Found NGame assets: @(NgAsset)"/>
  </Target>


  <Target Name="WriteNGAssetListFile"
          AfterTargets="AddCompanionFilesToNGAsset"
          Inputs="@(NgAssetChangeTrigger)"
          Outputs="$(IntermediateOutputPath)$(NGAssetListFile)">
    <Message Text="Updating NGame asset list..."/>
    <WriteLinesToFile
      Lines="@(NgAsset -> '$(NGAssetPackName)//$(ProjectDir)%(Identity)')"
      File="$(IntermediateOutputPath)$(NGAssetListFile)"
      Overwrite="true"
      Encoding="Unicode"/>
    <Message Text="NGame asset list updated."/>
  </Target>


  <Target Name="WriteNgUsedAssetListFile"
          AfterTargets="AddCompanionFilesToNGAsset"
          Condition="Exists('$(NgAppsettingsPath)')"
          Inputs="@(NgAssetLists)"
          Outputs="$(IntermediateOutputPath)$(NgUsedAssetListFile)">
    <Message Text="Update list of used NGame assets..."/>

    <Exec Command="dotnet tool list NGame.Assets.UsageDetector" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="PackageMissing"/>
    </Exec>

    <Exec Condition="$(PackageMissing)==1"
          Command="dotnet tool install NGame.Assets.UsageDetector ^
    --version 0.0.2-dev ^
    --create-manifest-if-needed"/>

    <Exec Command="dotnet tool update NGame.Assets.UsageDetector --version 0.0.6"/>

    <Exec Command="dotnet tool run ngame-asset-usages ^
    solutiondir=&quot;$(SolutionDir)\&quot; ^
    appsettings=&quot;$(ProjectDir)$(NgAppsettingsPath)&quot; ^
    output=&quot;$(ProjectDir)$(IntermediateOutputPath)$(NgUsedAssetListFile)&quot;"/>

    <Message Text="List of used NGame assets updated."/>
  </Target>


  <Target Name="DeleteNGAssetListFile" BeforeTargets="BeforeRebuild">
    <Delete Files="$(IntermediateOutputPath)$(NGAssetListFile)"/>
  </Target>

  <Target Name="DeleteNGAssetListFile" BeforeTargets="BeforeClean">
    <Delete Files="$(IntermediateOutputPath)$(NGAssetListFile)"/>
  </Target>


</Project>
